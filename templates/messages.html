{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="/static/fetures/Messages/styles.css">
{% endblock %}

{% block vkid %}
{% endblock %}

{% block content %}
<section class="messages_container">
    <h1>Chats</h1>
    <div class="chats_container" id="chatsContainer">
        </div>
</section>

<script>
    const chatsContainer = document.getElementById('chatsContainer');
    let websocket;

    function connectWebSocket() {
        websocket = new WebSocket(`wss://obmenyay-ru.ru/chats/ws/`);

        websocket.onopen = () => {
            console.log("WebSocket connection opened");
            // Отправляем запрос на получение начальных данных (если необходимо)
            websocket.send(JSON.stringify({ type: "get_chats" }));
        };

        websocket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "chats_update" || data.type === "initial_chats") {
                displayChats(data.chats);
            } else if (data.type === "new_message") {
                updateChat(data.chat_id, data.message);
            }
        };

        websocket.onclose = () => {
            console.log("WebSocket connection closed. Reconnecting in 3 seconds...");
            setTimeout(connectWebSocket, 3000); // Попытка переподключения
        };

        websocket.onerror = (error) => {
            console.error("WebSocket error:", error);
        };
    }

    function displayChats(chats) {
        chatsContainer.innerHTML = ''; // Очищаем контейнер перед обновлением

        chats.forEach(chat => {
            const chatButton = document.createElement('button');
            chatButton.classList.add('chat');
            chatButton.id = chat.trade_id;

            chatButton.onclick = () => {
                window.location.href = `./messages.html?trade_id=${chat.trade_id}`; // Передача trade_id
            };

            if (chat.is_my_item) {
                const myItemDiv = document.createElement('div');
                myItemDiv.classList.add('is_my_item');
                myItemDiv.innerHTML = '<span>моё</span>';
                chatButton.appendChild(myItemDiv);
            }

            const avatarContainer = document.createElement('div');
            avatarContainer.classList.add('avatar_container');
            const avatarImg = document.createElement('img');
            avatarImg.src = chat.user.image_url;
            avatarImg.alt = 'аватарка';
            avatarContainer.appendChild(avatarImg);
            chatButton.appendChild(avatarContainer);

            const chatTextDiv = document.createElement('div');
            chatTextDiv.classList.add('chat_text');

            const labelContainer = document.createElement('label');
            labelContainer.classList.add('label_container');

            const userNameSpan = document.createElement('span');
            userNameSpan.classList.add('label_container_userName');
            userNameSpan.textContent = chat.user.fullname;

            const itemNameSpan = document.createElement('span');
            itemNameSpan.classList.add('label_container_nameItem');
            itemNameSpan.id = chat.item.id;
            itemNameSpan.textContent = chat.item.name;

            labelContainer.appendChild(userNameSpan);
            labelContainer.appendChild(itemNameSpan);
            chatTextDiv.appendChild(labelContainer);

            const lastMessageP = document.createElement('p');
            lastMessageP.classList.add('chat_last_message');
            lastMessageP.textContent = chat.last_message || ""; // Обработка случая отсутствия сообщений
            chatTextDiv.appendChild(lastMessageP);

            chatButton.appendChild(chatTextDiv);
            chatsContainer.appendChild(chatButton);
        });
    }

    function updateChat(chat_id, message) {
        const chatButton = document.getElementById(chat_id);
        if (chatButton) {
            const lastMessageP = chatButton.querySelector('.chat_last_message');
            if (lastMessageP) {
                lastMessageP.textContent = message;
            }
        }
    }

document.addEventListener('DOMContentLoaded', () => {
     const burger = document.querySelector('.burger-menu');
            if (burger) {
                burger.classList.add('active');
            }
            connectWebSocket();
        });
</script>

{% endblock %}