{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="/static/fetures/Messages/styles.css">
    <link rel="stylesheet" href="/static/fetures/Messages/message.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>

{% endblock %}

{% block content %}
                <section class="messages_container">
                    <div class="section_head">
                        <h1> <img src="/static/icon/user.svg" width="20px" alt="user_icon">Николай</h1>
                        <button id="delete_chat_btn" onclick="window.delete_chat.showModal()"><img
                                src="/static/icon/delete.svg" alt="delete_icon"></button>
                    </div>
                    <div class="trade_item_box">
                        <button class="item" id="selected_item" type="button"
                            onclick="window.choose_thing.showModal()">Выбрать
                            вещь</button>
                        <img src="/static/icon/logo/logo.svg" alt="">
                        <div class="item">Ручка</div>
                    </div>
                    <div class="message_container">
                        <div class="notification_container active" id="statusMessage">
                            <span>Ожидание ответа от пользователя</span>
                        </div>
                        <div class="notification_container_choices">
                            <span>Пользователь готов обсудить если вы предложите данный товар:</span>
                            <div key="1" class="img_container_notify"
                                style="background-image:url('/static/img/1.jpg')">
                                <img src="/static/img/1.jpg" alt="" />
                            </div>
                            <div class="choice_btn_box">
                                <button class="agree_btn" type="button" id="agree_trade">Да</button>
                                <button class="refusal_btn" type="button" id="refusal_btn">Нет</button>
                            </div>
                        </div>
                        <!-- <div class="message">
                            <img src="https://avatars.mds.yandex.net/i?id=561543dbc4c04e48e3dfecb21134d955_l-4299853-images-thumbs&n=13" alt="avatar">
                            <div class="message_text">
                                <p>Да, давай. Согласен встретиться на перемене</p>
                                <p>Да, давай. Согласен встретиться на перемене</p>
                                <p>Да, давай. Согласен встретиться на перемене</p>
                                <p>Да, давай. Согласен встретиться на перемене</p>
                                <p>Да, давай. Согласен встретиться на перемене</p>
                            </div>
                        </div>
                        <div class="message">

                            <div class="message_text">
                                <p>Да, давай. Согласен встретиться на перемене</p>
                            </div>
                            <img src="https://avatars.mds.yandex.net/i?id=561543dbc4c04e48e3dfecb21134d955_l-4299853-images-thumbs&n=13" alt="avatar">
                        </div>
                        <div class="message">
                            <img src="https://avatars.mds.yandex.net/i?id=561543dbc4c04e48e3dfecb21134d955_l-4299853-images-thumbs&n=13" alt="avatar">
                            <div class="message_text">
                                <p>Да, давай. Согласен встретиться на перемене</p>
                            </div>
                        </div> -->
                    </div>
                    <div class="input_message">
                        <input id="chat_input" type="text" placeholder="">
                        <img src="/static/icon/message/icon.svg" alt="message_icon">
                    </div>
                    <!-- ====================== -->
                    <dialog id="choose_thing">
                        <h2>Выбрать вещь</h2>
                        <button class="close_modal" type="button">
                            <img src="/static/icon/persobnalCabinet/close.svg" alt="close_form">
                        </button>
                        <div class="swiper-container">
                            <div class="swiper-wrapper" id="thing_list"></div>
                            <div class="swiper-pagination"></div>
                        </div>
                    </dialog>
                    <!-- ====================== -->
                    <dialog id="delete_chat">
                        <h2>Удалить этот чат</h2>
                        <button class="close_modal" type="button">
                            <img src="https://obmenyay-ru.ru/static/icon/persobnalCabinet/close.svg" alt="close_form">
                        </button>
                        <div class="text_container">
                            Вы действительно хотите удалить этот чат ?
                        </div>
                        <button type="button" id="cancellation_chat" class="add_thing_button">Отменить</button>
                        <button type="button" id="remove_chat" class="add_thing_button">Удалить</button>
                    </dialog>
                </section>

<script>
const thingList = document.getElementById('thing_list');
const selectedItemButton = document.getElementById('selected_item');
let selectedItem = localStorage.getItem('selectedItem');

const ws = new WebSocket('wss://obmenyay-ru.ru/chats/ws/{{ trade_id }}');

let currentStatus = null;
let currentItems = [];

ws.onmessage = function (event) {
    const data = JSON.parse(event.data);
    console.log(data);
    switch (data.type) {
        case 'initial_data':
            currentStatus = data.status;
            currentItems = data.items;
            updateStatusMessage(currentStatus, currentItems);
            displayItems(currentItems);
            break;
        case 'status':
            currentStatus = data.status;
            updateStatusMessage(currentStatus, "Товар");
            break;
        case 'items':
            currentItems = data.items;
            displayItems(currentItems);
            break;
    }
};

function displayItems(items) {
  thingList.innerHTML = '';

  items.forEach(item => {
    const slide = document.createElement('div');
    slide.className = 'swiper-slide';
    slide.innerHTML = `
      <span class="item__selected" style="display: none;">Выбрана</span>
      <div key="${item.id}" class="img_container" style="background-image: url(${item.image});">
        <img src="${item.image}" alt="${item.name}" />
      </div>
      <div class="item-name">${item.name}</div>
      <button class="select-button" data-id="${item.id}">Выбрать</button>
    `;

    const selectButton = slide.querySelector('.select-button');
    selectButton.addEventListener('click', async (event) => {
      event.stopPropagation();

      // Очищаем предыдущий выбор
      document.querySelectorAll('.item__selected').forEach(span => {
        span.classList.remove('selected');
        span.style.display = 'none';
      });

      const selectedSpan = slide.querySelector('.item__selected');
      selectedSpan.classList.add('selected');
      selectedSpan.style.display = 'block';

      selectedItemButton.textContent = item.name;
      localStorage.setItem('selectedItem', item.name);

      try {
        const response = await fetch('https://obmenyay-ru.ru/trades/{{ trade_id }}/choose-item', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ item_id: Number(item.id) })
        });

        if (!response.ok) {
          throw new Error(`Ошибка запроса к /foo: ${response.status}`);
        }

        const data = await response.json();
        console.log('Успешный запрос к /foo:', data);
      } catch (error) {
        console.error('Ошибка при запросе к /foo:', error);
      } finally {
        document.getElementById('choose_thing').close();
      }
    });

    thingList.appendChild(slide);
  });
}


    function updateStatusMessage(status, items) {
        const statusMessageElement = document.getElementById('statusMessage');

        switch (status) {
            case 'waiting':
                statusMessageElement.textContent = 'Ожидание ответа от пользователя';
                document.getElementById('selected_item').disabled = true;
                break;
            case 'choose item':
                statusMessageElement.textContent = 'Пожалуйста, выберите вещь для обмена';
                break;
            case 'final answer':
                document.querySelector('.notification_container').classList.remove('active');
                document.querySelector('.notification_container_choices').classList.add('active');
                document.getElementById('selected_item').disabled = true;
                selectedItemButton.textContent = items[0].name;
                const imgContainer = document.querySelector('.img_container_notify');
                const imageUrl = items[0].image;
                imgContainer.style.backgroundImage = `url(${imageUrl})`;
                const imgElement = imgContainer.querySelector('img');
                imgElement.src = imageUrl;
                break;
            case 'active':
                document.querySelector('.input_message').classList.add('agree');
                document.querySelector('.notification_container').classList.remove('active');
                document.getElementById('selected_item').disabled = true;
                selectedItemButton.textContent = item_name;
                break;
        }
    }




    document.querySelectorAll('.close_modal').forEach(button => {
        button.addEventListener('click', (event) => {
            const dialog = event.target.closest('dialog');
            if (dialog) {
                dialog.close();
            }
        });
    });

    document.getElementById('cancellation_chat').addEventListener('click', () => {
        const dialog = event.target.closest('dialog');
        if (dialog) {
            dialog.close();
        }
    });

    document.getElementById('remove_chat').addEventListener('click', () => {
        deleteChat();
    });


document.getElementById('agree_trade').addEventListener('click', async () => {
    document.querySelector('.input_message').classList.add('agree');
    document.querySelector('.notification_container_choices').classList.remove('active');

    const tradeId = '{{ trade_id }}';

    try {
        const response = await fetch(`https://obmenyay-ru.ru/trades/${tradeId}/match`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Network response was not ok');
        }

        const data = await response.json();
        console.log(data);

    } catch (error) {
        console.error('There was a problem with the fetch operation:', error);
    }
});


cument.getElementById('refusal_btn').addEventListener('click', () => {
    document.querySelector('.notification_container_choices').classList.remove('active');
    deleteChat(); // Вызываем функцию удаления чата
});

async function deleteChat() {
    const tradeId = '{{ trade_id }}';

    if (!tradeId) {
        console.error("Не удалось получить ID сделки.");
        return; // Прерываем выполнение функции
    }

    try {
        const response = await fetch(`/trades/${tradeId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json' // Закрывающая фигурная скобка добавлена здесь
            }
        }); // Закрывающая скобка для fetch

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`Ошибка при удалении сделки (код ${response.status}): ${errorText}`);
            alert(`Ошибка удаления: ${response.status} - ${errorText}`);
            return;
        }

        console.log('Сделка успешно удалена.');

        window.location.href = 'https://obmenyay-ru.ru/chats/';

    } catch (error) {
        console.error('Ошибка при выполнении запроса:', error);
        alert("Произошла ошибка при удалении. Пожалуйста, попробуйте позже.");
    }
} // Закрывающая фигурная скобка для функции


    document.getElementById('chat_input').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            const message = event.target.value.trim();
            if (message) {
                console.log(message);
                event.target.value = '';
                // дальше тут работа с websocket
            }
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
     const burger = document.querySelector('.burger-menu');
            if (burger) {
                burger.classList.add('active');
            }
        updateStatusMessage();
        });
</script>
{% endblock %}
