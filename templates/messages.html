{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="/static/fetures/Messages/styles.css">
    <link rel="stylesheet" href="/static/fetures/Messages/message.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>

{% endblock %}

{% block content %}
    <section class="messages_container">
        <div class="section_head">
            <h1 id="companion_name"></h1><img id="companion_image" src="" width="20px" alt="user_icon">
            <button id="delete_chat_btn" onclick="window.delete_chat.showModal()"><img src="/static/icon/delete.svg" alt="delete_icon"></button>
        </div>
                    <div class="trade_item_box">
                        <button class="item" id="selected_item" type="button"
                            onclick="window.choose_thing.showModal()">Выбрать
                            вещь</button>
                        <img src="/static/icon/logo/logo.svg" alt="">
                        <div class="item">Ручка</div>
                    </div>

        <div class="message_container" id="message_container">
            <div class="notification_container" id="statusMessage"></div>
            <div class="notification_container_choices" id="choices_container">
                <span>Вы согласны на обмен?</span>
                <div class="choice_btn_box">
                    <button class="agree_btn" type="button" id="agree_trade">Да</button>
                    <button class="refusal_btn" type="button" id="refusal_btn">Нет</button>
                </div>
            </div>
        </div>
        <div class="input_message" id="input_message">
            <input id="chat_input" type="text" placeholder="">
            <img src="/static/icon/message/icon.svg" alt="message_icon">
        </div>
                    <dialog id="choose_thing">
                        <h2>Выбрать вещь</h2>
                        <button class="close_modal" type="button">
                            <img src="/static/icon/persobnalCabinet/close.svg" alt="close_form">
                        </button>
                        <div class="swiper-container">
                            <div class="swiper-wrapper" id="thing_list"></div>
                            <div class="swiper-pagination"></div>
                        </div>
                    </dialog>
    </section>

<script>
    const testJson = [
        {
            status: 'waiting for owner'
        },
        {
            status: 'choose item'
        }
    ];
    const items = [
        {id:1, name: 'Ручка', image: '/static/img/1.jpg' },
        {id:2, name: 'Блокнот', image: '/static/img/fork.png' },
        {id:3, name: 'Книга', image: '/static/img/pencils.png' },
        {id:4, name: 'Кружка', image: '/static/img/3.jpg' },
        {id:5, name: 'Игрушка', image: '/static/img/book.png' }
    ];
    const thingList = document.getElementById('thing_list');
    const selectedItemButton = document.getElementById('selected_item');
    let selectedItem = localStorage.getItem('selectedItem');

    if (testJson[1].status === 'choose_item') {
        (async function getUserThings() {
            await fetch(`/items/users/${user_id}`, {
                method: 'GET',
            })
                .then((data) => displayItems(data)) // Смотри, тут еще может быть такое момент res.data в зависимости от того как приходит ответ.
                .catch((error) => { throw new Error('Ошибка сети: ' + error) });
        })()
    }

    function displayItems(data) {
        thingList.innerHTML = '';
        // Тут надо data вместо заглушки
        items.forEach(item => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            slide.innerHTML = `
            <span class="item__selected" style="display: none;">Выбрана</span>
            <div key="${item.id}" class="img_container" style="background-image: url(${item.image});">
                <img src="${item.image}" alt="${item.name}" />
            </div>
            <div class="item-name">${item.name}</div>
             <button class="select-button" data-id="${item.id}">Выбрать</button>
        `;

            const selectButton = slide.querySelector('.select-button');
            selectButton.addEventListener('click', (event) => {
                event.stopPropagation();

                document.querySelectorAll('.item__selected').forEach(span => {
                    span.classList.remove('selected');
                    span.style.display = 'none';
                });

                const selectedSpan = slide.querySelector('.item__selected');
                selectedSpan.classList.add('selected');
                selectedSpan.style.display = 'block';

                selectedItemButton.textContent = item.name;
                localStorage.setItem('selectedItem', item.name);
                document.getElementById('choose_thing').close();
            });

            thingList.appendChild(slide);
        });
    }

    const swiper = new Swiper('.swiper-container', {
        slidesPerView: 1,
        spaceBetween: 10,
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
    });

    document.querySelectorAll('.close_modal').forEach(button => {
        button.addEventListener('click', (event) => {
            const dialog = event.target.closest('dialog');
            if (dialog) {
                dialog.close();
            }
        });
    });

    displayItems();


    function updateStatusMessage() {
        const statusMessageElement = document.getElementById('statusMessage');
        const currentStatus = testJson[1].status;

        switch (currentStatus) {
            case 'waiting for owner':
                statusMessageElement.textContent = 'Ожидание ответа от пользователя';
                break;
            case 'choose item':
                statusMessageElement.textContent = 'Пожалуйста, выберите вещь для обмена';
                break;
            default:
                throw new Error('status unknown');
        }
    }

    document.querySelectorAll('.close_modal').forEach(button => {
        button.addEventListener('click', (event) => {
            const dialog = event.target.closest('dialog');
            if (dialog) {
                dialog.close();
            }
        });
    });

    document.getElementById('cancellation_chat').addEventListener('click', () => {
        const dialog = event.target.closest('dialog');
        if (dialog) {
            dialog.close();
        }
    });

    document.getElementById('remove_chat').addEventListener('click', () => {
        // Саша, тут запрос на удаление чата :)
    });
    //189

    document.getElementById('agree_trade').addEventListener('click', () => {
        document.querySelector('.input_message').classList.add('agree');
        document.querySelector('.notification_container_choices').classList.remove('active');

        // дальше тут работа с websocket , мб выдавать собеседнику сообщение типа "собеседник согласился на обмен"
    });

    document.getElementById('refusal_btn').addEventListener('click', () => {
        document.querySelector('.notification_container_choices').classList.remove('active');
        // Тута логика при отказе , мб , дальнейшее удаление чата , тогда надо удаление вынести в функцию :)
    });

    function deleteChat() {
        // запрос
    }

    document.getElementById('chat_input').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
            const message = event.target.value.trim();
            if (message) {
                console.log(message);
                event.target.value = '';
                // дальше тут работа с websocket
            }
        }
    });

    updateStatusMessage();
</script>
{% endblock %}
