{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="/static/fetures/Messages/styles.css">
    <link rel="stylesheet" href="/static/fetures/Messages/message.css">
{% endblock %}

{% block vkid %}
{% endblock %}

{% block content %}
<section class="messages_container">
    <h1>Chats</h1>
    <div class="chats_container" id="chatsContainer">
        </div>
</section>

<script>
    const chatsContainer = document.getElementById('chatsContainer');
    let websocket;

    function connectWebSocket() {
        websocket = new WebSocket(`wss://obmenyay-ru.ru/chats/ws/`);

        websocket.onopen = () => {
            console.log("WebSocket connection opened");
            // Отправляем запрос на получение начальных данных (если необходимо)
            websocket.send(JSON.stringify({ type: "get_chats" }));
        };

        websocket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === "chats_update" || data.type === "initial_chats") {
                displayChats(data.chats);
            } else if (data.type === "new_message") {
                updateChat(data.chat_id, data.message);
            }
        };

        websocket.onclose = () => {
            console.log("WebSocket connection closed. Reconnecting in 3 seconds...");
            setTimeout(connectWebSocket, 3000); // Попытка переподключения
        };

        websocket.onerror = (error) => {
            console.error("WebSocket error:", error);
        };
    }

    function displayChats(chats) {
        chatsContainer.innerHTML = ''; // Очищаем контейнер перед обновлением

        chats.forEach(chat => {
            const chatButton = document.createElement('button');
            chatButton.classList.add('chat');
            chatButton.id = chat.trade_id;

            chatButton.onclick = () => {
                window.location.href = `./messages.html?trade_id=${chat.trade_id}`; // Передача trade_id
            };

            if (chat.is_my_item) {
                const myItemDiv = document.createElement('div');
                myItemDiv.classList.add('is_my_item');
                myItemDiv.innerHTML = '<span>моё</span>';
                chatButton.appendChild(myItemDiv);
            }

            const avatarContainer = document.createElement('div');
            avatarContainer.classList.add('avatar_container');
            const avatarImg = document.createElement('img');
            avatarImg.src = chat.user.image_url;
            avatarImg.alt = 'аватарка';
            avatarContainer.appendChild(avatarImg);
            chatButton.appendChild(avatarContainer);

            const chatTextDiv = document.createElement('div');
            chatTextDiv.classList.add('chat_text');

            const labelContainer = document.createElement('label');
            labelContainer.classList.add('label_container');

            const userNameSpan = document.createElement('span');
            userNameSpan.classList.add('label_container_userName');
            userNameSpan.textContent = chat.user.fullname;

            const itemNameSpan = document.createElement('span');
            itemNameSpan.classList.add('label_container_nameItem');
            itemNameSpan.id = chat.item.id;
            itemNameSpan.textContent = chat.item.name;

            labelContainer.appendChild(userNameSpan);
            labelContainer.appendChild(itemNameSpan);
            chatTextDiv.appendChild(labelContainer);

 const lastMessageContainer = document.createElement('div');
            lastMessageContainer.classList.add('last_message_container');

            const svgIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svgIcon.setAttribute("viewBox", "0 0 460.702 460.702");
            svgIcon.setAttribute("width", "20px");
            svgIcon.setAttribute("height", "20px");

            const fillColor = chat.last_message.is_seen ? "#5C95C3" : "rgb(143, 143, 143)";


            svgIcon.innerHTML = `
                            <g>
                                <path d="m316.608 121.805c-8.937-9.037-23.499-9.151-32.576-.254l-170.268 168.282-74.017-76.626c-8.828-9.201-23.443-9.503-32.643-.675-9.201 8.828-9.503 23.443-.675 32.643.04.041.079.082.119.123l90.248 93.526c4.319 4.406 10.222 6.901 16.392 6.926h.254c6.053-.019 11.857-2.415 16.161-6.672l186.797-184.697c9.025-8.95 9.117-23.511.208-32.576z" fill="${fillColor}"/>
                                <path d="m235.318 338.824c4.308 4.395 10.192 6.888 16.346 6.926h.254c6.053-.019 11.857-2.415 16.161-6.672l186.798-184.697c8.467-9.534 7.602-24.126-1.931-32.593-8.643-7.676-21.63-7.777-30.391-.237l-170.199 168.282-6.072-6.303c-8.827-9.201-23.442-9.504-32.643-.676-9.201 8.827-9.504 23.442-.676 32.643.04.042.08.083.12.124z" fill="${fillColor}"/>
                            </g>
                            `;

            lastMessageContainer.appendChild(svgIcon);

            const lastMessageP = document.createElement('p');
            lastMessageP.classList.add('chat_last_message');
            lastMessageP.textContent = chat.last_message.text;

            lastMessageContainer.appendChild(lastMessageP);
            chatTextDiv.appendChild(lastMessageContainer);
            chatButton.appendChild(chatTextDiv);
            chatsContainer.appendChild(chatButton);
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
     const burger = document.querySelector('.burger-menu');
            if (burger) {
                burger.classList.add('active');
            }
            connectWebSocket();
        });


</script>
{% endblock %}